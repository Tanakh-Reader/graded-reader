{% extends 'layout.html' %}
{% load static %}
{% load list_extras %}

{% block title %}Passages Page{% endblock %}

{% block content %}

    <!-- Container to hold the columns and the canvas, positioned relatively -->
    <div class="relative flex justify-center gap-3">
        <div id="column-0"
             class="flex flex-col items-end gap-1">
            <!-- Column 1 Header -->
            <div class="mb-2 font-bold">#</div>
            <!-- Column 1 Items -->
            {% for item in listA %}
                <div class="flex border border-transparent">
                    <div class="">{{ forloop.counter }}</div>
                </div>
            {% endfor %}
        </div>
        <div id="column-1"
             class="mr-52 flex flex-col items-end gap-1">
            <!-- Column 1 Header -->
            <div class="mb-2 font-bold">Algorithm A</div>
            <!-- Column 1 Items -->
            {% for item in listA %}
                <div class="col-1 passage-item flex w-60 overflow-hidden rounded-md border border-black"
                     data-passage="{{ item.0 }}"
                     data-index="{{ forloop.counter }}">
                    <div class="w-1/3 bg-red-100 px-2">{{ item.1 }}</div>
                    <div class="w-2/3 bg-gray-100 px-2 text-right">{{ item.0 }}</div>
                </div>
            {% endfor %}
        </div>
        <div id="column-2"
             class="flex flex-col items-start gap-1">
            <!-- Column 2 Header -->
            <div class="mb-2 font-bold">Algorithm B</div>
            <!-- Column 2 Items -->
            {% for item in listB %}
                <div class="passage-item flex w-60 overflow-hidden rounded-md border border-black"
                     data-passage="{{ item.0 }}"
                     data-index="{{ forloop.counter }}">
                    <div class="w-2/3 bg-gray-100 px-2">{{ item.0 }}</div>
                    <div class="w-1/3 bg-red-100 px-2">{{ item.1 }}</div>
                </div>
            {% endfor %}
        </div>
    </div>
    <div id="hover-text"
         class="absolute z-50 hidden rounded border border-gray-400 bg-white px-1 shadow-lg">
    </div>

    <script src="{% static 'js/libraries/leader-line.min.js' %}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const colors = [
                '#E53E3E',
                '#DD6B20',
                '#38A169',
                '#3182CE',
                '#805AD5',
                '#D53F8C',
                '#0F766E',
                '#ECC94B',
                '#7B341E',
                '#4C51BF'
            ];

            const lineReferences = {};
            const passageColors = {};
            const col1Items = document.querySelectorAll('#column-1 .passage-item');
            const col2Items = document.querySelectorAll('#column-2 .passage-item');
            const hoverTextDiv = document.getElementById('hover-text');

            function showHoverText(div) {
                // Get the text
                const passage = div.getAttribute('data-passage');
                const col = div.classList.contains('col-1') ? 2 : 1;
                const match = document.querySelector(`#column-${col} .passage-item[data-passage='${passage}']`);
                const selectedIndex = div.getAttribute('data-index');
                const matchingIndex = match.getAttribute('data-index');
                const difference = -(selectedIndex - matchingIndex);

                // Position the hover text div next to the hovered div
                const rect = div.getBoundingClientRect();
                hoverTextDiv.style.top = `${rect.top + window.scrollY}px`;
                hoverTextDiv.style.left = `${rect.right + window.scrollX + 10}px`; // 10px to the right
                hoverTextDiv.innerHTML = `<span class="font-bold text-red-500">${difference}</span>: ${selectedIndex}â†’${matchingIndex}`; // Set the text
                hoverTextDiv.classList.remove('hidden'); // Show the div
            }

            function handlePassageClicked(div) {
                const currentSelection = document.querySelector(".selected-passage");
                if (currentSelection && div.getAttribute('data-passage') === currentSelection.getAttribute('data-passage')) {
                    // Clicking the same passage again: unselect and reset highlight
                    highlightPassageAndLine(currentSelection, null, true); // Reset the highlight
                    currentSelection.classList.remove("selected-passage");
                } else {
                    // New passage clicked or no current selection
                    if (currentSelection) {
                        // Reset previous selection
                        highlightPassageAndLine(currentSelection, null, true);
                        currentSelection.classList.remove("selected-passage");
                    }
                    // Highlight and select the new passage
                    div.classList.add("selected-passage");
                    highlightPassageAndLine(div, "#242423"); // Highlight with new color
                }
            }

            function highlightPassageAndLine(div, color = null, reset = false) {
                const passage = div.getAttribute('data-passage');
                const lineSize = reset ? 1 : 4;
                const borderWidth = reset ? '' : '2px';
                color = color || passageColors[passage];
                lineReferences[passage].setOptions({
                    color: color,
                    size: lineSize
                });
                // Highlight passages
                document.querySelectorAll(`[data-passage="${passage}"]`).forEach(div => {
                    div.style.borderColor = color;
                    div.style.borderWidth = borderWidth;
                });
                showHoverText(div)
                if (reset) {
                    hoverTextDiv.classList.add("hidden")
                }
            }

            col1Items.forEach((item, index) => {
                const passage = item.getAttribute('data-passage');
                const match = document.querySelector(`#column-2 .passage-item[data-passage='${passage}']`);
                if (match) {
                    passageColors[passage] = colors[index % colors.length];
                    item.style.borderColor = passageColors[passage]
                    match.style.borderColor = passageColors[passage]
                    var line = new LeaderLine(
                        item,
                        match, {
                            size: 1,
                            color: passageColors[passage],
                            path: 'straight',
                            endPlug: 'behind'
                        }
                    );
                    lineReferences[passage] = line;
                }
            });

            // Add event listeners
            [col1Items, col2Items].forEach((column) => {
                column.forEach((item) => {
                    item.addEventListener('mouseenter', () => {
                        if (!item.classList.contains("selected-passage")) {
                            highlightPassageAndLine(item, "#f7f5ad");
                        }
                    });
                    item.addEventListener('mouseleave', () => {
                        if (!item.classList.contains("selected-passage")) {
                            highlightPassageAndLine(item, null, true); // Reset on mouse leave
                        }
                    });
                    item.addEventListener('click', () => handlePassageClicked(item));
                });
            });
        });
    </script>

{% endblock %}
